<header class="navbar">
    <div class="navbar-brand">
        <a href="/" class="logo">AIåˆ›é€ äº’åŠ©ç¤¾åŒº</a>
    </div>

    <nav class="navbar-menu">
        <a href="/posts" class="nav-link">æµè§ˆæ±‚åŠ©</a>
        <a href="/categories" class="nav-link">åˆ†ç±»</a>
        {% if user %}
            <a href="/posts/create" class="nav-link btn-primary">å‘å¸ƒæ±‚åŠ©</a>

            <!-- æ¶ˆæ¯é€šçŸ¥ -->
            <div class="dropdown message-dropdown">
                <button class="dropdown-toggle message-icon"
                        hx-get="/messages/unread-count"
                        hx-trigger="load, every 30s"
                        hx-swap="innerHTML">
                    <span class="icon">ğŸ””</span>
                    <span class="badge" id="unread-badge" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu message-menu">
                    <div class="message-header">
                        <span>æ¶ˆæ¯é€šçŸ¥</span>
                        <a href="/messages" class="view-all">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>
                    <div class="message-list"
                         hx-get="/messages/recent"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="message-loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="dropdown-toggle">{{ user.nickname }}</button>
                <div class="dropdown-menu">
                    <a href="/users/profile" class="dropdown-item">ä¸ªäººèµ„æ–™</a>
                    {% if user.user_role in ['solver', 'both'] %}
                    <a href="/users/solver/profile" class="dropdown-item">è§£å†³è€…èµ„æ–™</a>
                    {% endif %}
                    <hr>
                    <form action="/auth/logout" method="post">
                        <button type="submit" class="dropdown-item">é€€å‡ºç™»å½•</button>
                    </form>
                </div>
            </div>
        {% else %}
            <a href="/auth/login" class="nav-link">ç™»å½•</a>
            <a href="/auth/register" class="nav-link btn-primary">æ³¨å†Œ</a>
        {% endif %}
    </nav>
</header>

<style>
.message-dropdown {
    position: relative;
}

.message-icon {
    position: relative;
    font-size: 1.25rem;
    padding: 0.5rem;
}

.message-icon .badge {
    position: absolute;
    top: 0;
    right: 0;
    background: var(--danger-color);
    color: white;
    font-size: 0.7rem;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}

.message-menu {
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
}

.message-header .view-all {
    font-size: 0.875rem;
    color: var(--primary-color);
    text-decoration: none;
}

.message-list {
    max-height: 300px;
    overflow-y: auto;
}

.message-item {
    display: block;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    text-decoration: none;
    color: var(--text-color);
    transition: background 0.2s;
}

.message-item:hover {
    background: var(--background-color);
}

.message-item.unread {
    background: #f0f4ff;
}

.message-item .message-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.message-item .message-preview {
    font-size: 0.8rem;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.message-item .message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.message-loading, .message-empty {
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
}
</style>
